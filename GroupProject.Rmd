---
title: "PM-GroupProject"
author: "Dennis Goldenberg, Solomon Gao, Suleman Sadiq, Alana Berson"
date: "2024-04-23"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = TRUE, message = FALSE}
library(readxl)
library(ggplot2)
suppressWarnings(library(zoo))
library(nlme)
```

# 1. Data Exploration and Preprocessing
Reading in USA fatality data:
```{r, include = TRUE}
USAFat <- as.vector(t(as.matrix(read_excel("data/USA-FatalCrashes.xlsx",
  range = "B8:M22", col_names = FALSE,.name_repair = "unique_quiet"))))
```

Reading in USA population data (in hundreds of thousands):
```{r, include = TRUE}
USAPOP <- read_excel("data/USAPOP.xlsx")
colnames(USAPOP) <- c("Year", "Alabama","Alaska","Arizona","Arkansas",
 "California","Colorado","Connecticut","Delaware","D.C.","Florida","Georgia",
 "Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana",
 "Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi",
 "Missouri","Montana", "Nebraska","Nevada", "New Hampshire","New Jersey",
 "New Mexico","New York","North Carolina", "North Dakota","Ohio", "Oklahoma",   
 "Oregon", "Pennsylvania", "Rhode Island","South Carolina", "South Dakota", 
 "Tennessee","Texas", "Utah", "Vermont", "Virginia", "Washington",
 "West Virginia","Wisconsin", "Wyoming")
USAPOP$Year <- (2008:2023)*1000
USAPOP <- USAPOP/1000
USAPOP$Year <- as.integer(USAPOP$Year)
```


## a. Seasonality of Data
```{r, include = TRUE}
USADate <- as.yearmon("2008-01") + seq((1/12),(180/12), by = (1/12)) - (1/12)
USAData <- zoo(USAFat, USADate)
plot(USAData, main = "USA Fatal Motor Vehicle Crashes by Month, 2008-2022",
     xlab = "Month and Year", ylab = "Monthly Fatal Vehicle Crashes")
```
Examining a typical year:
```{r, include=TRUE}
plot(USAData[49:60], main = "USA Fatal Motor Vehicle Crashes by Month, 2013",
     xlab = "Month", ylab = "Monthly Fatal Vehicle Crashes")
```
Looking at the Seasonality:
```{r, include = TRUE}
tsUSA <- ts(USAFat, start = 2008, freq = 12)
plot(decompose(tsUSA, type = "add"))
```


## b. Collecting fatality data on states that legalized pre-2022
```{r, include = TRUE}
legStates <- c("Colorado", "Washington", "D.C.","Oregon", "Alaska","California",
               "Massachusetts", "Nevada", "Maine", "Vermont", "Michigan",
               "Illinois", "Arizona", "Montana", "New Jersey", "New York",
               "New Mexico", "Virginia", "Connecticut")
legEffDate <- as.yearmon("2012-11") + 
  (c(1,2,29,33,39,49,50,51,52,69,74,87,98,99,101,102,105,105,105)/12) - (1/12)
```

## c. Calculating State by State Population Data



# 2. Modeling

## a. Autocorrelation function

```{r, include = TRUE}
pacf(USAData)
```

```{r, include = TRUE}
arima(USAData, order = c(1,0,0), method = "ML")
?arima
```


## b. Difference of Means on Panel Data
I do a difference of means test to see if there is a change in the average number of fatal crashes per 100,000 in the year pre-legalization vs. the year when legalization went into effect. I linearly interpolate between population estimates to get the population estimate to divide by (i.e. if legalization went into effect at March 2015, I take 2/12 of the population of 2015 and add 10/12 of the population of 2014 for the pre-legalization population):
```{r, include = TRUE}
effDatefracs <- as.numeric(legEffDate) - as.integer(legEffDate)
yearsLeg <- as.integer(legEffDate)
avgs_pre <- c()
avgs_post <- c()
for(i in 1:length(legStates)){
  stateInfo <- as.vector(t(as.matrix(read_excel(
    paste("data/",legStates[i],".xlsx",sep = ""),range = "B9:M23",
    col_names = FALSE,.name_repair = "unique_quiet"))))
  
  #linear interpolation
  pop_est_pre <- effDatefracs[i] * USAPOP[yearsLeg[i] - 2007,legStates[i]] +
    (1 - effDatefracs[i]) * USAPOP[yearsLeg[i] - 2008,legStates[i]]
  pop_est_post <- (1-effDatefracs[i])*USAPOP[yearsLeg[i] - 2007,legStates[i]]+ 
    effDatefracs[i] * USAPOP[yearsLeg[i] - 2006,legStates[i]]
  
  #find point in state info, calculate averages
  index_Leg <- (as.numeric(legEffDate[i]) - 2008)*12 + 1
  pre_per_HT <- mean(stateInfo[(index_Leg - 12):(index_Leg - 1)])/pop_est_pre
  post_per_HT <-  mean(stateInfo[(index_Leg):(index_Leg + 12)])/pop_est_post
  avgs_pre <- append(avgs_pre,pre_per_HT)
  avgs_post <- append(avgs_post, post_per_HT)
}
hist(avgs_post - avgs_pre, breaks = 10, 
     main = "Differences of Average Fatal Crash Number, Pre/Post Legalization",
     xlab = "Difference")
```

I generate the data-frame with data, and run a paired sample t-test:
```{r, include = TRUE}
pairedData <- as.data.frame(cbind(legStates,avgs_pre,avgs_post))
colnames(pairedData) <- c("State", "avg_pre_Leg","avg_post_Leg")
pairedData$avg_pre_Leg <-round(as.numeric(pairedData$avg_pre_Leg),6)
pairedData$avg_post_Leg <- round(as.numeric(pairedData$avg_post_Leg),6)
testMeans <- t.test(pairedData$avg_post_Leg, pairedData$avg_pre_Leg, 
       paired = TRUE, alternative = "greater")
```

The test statistic is $t = \frac{m}{\frac{s}{\sqrt{n}}}$, where $m$ is the mean difference, $s$ is the sample standard deviation of the difference, and $n$ is the number of observations (in this case, 19). I calculate:

```{r, include = TRUE}
sprintf("Sample Mean Difference: %.5f", testMeans$estimate)
sprintf("Test statstic: %.5f",testMeans$statistic["t"])
sprintf("Degrees of Freedom: %.0f", testMeans$parameter)
sprintf("p-value: %.5f", testMeans$p.value)
print("95% Confidence Interval:")
print(testMeans$conf.int[1:2])
```
So, $\mathbb{P}(T_{18} > 2.41257) = 0.01336 < 0.05$; I reject $H_0$ at $\alpha = 0.05$.


## c. Random Forest to Predict Crashes
Features to split on: (Note Rhode Island legalized on 05/22/2022 so it should probably be excluded)
\begin{itemize}
\item Marijuana Legal? (Pre-2022)
\item Proportion of Population in Urban Areas
\item Percent Elderly Population
\item 
\item 
\end{itemize}

```{r, include = TRUE}
avg2022 <- as.vector(t(as.matrix(read_excel("rfdata/2022StateData.xlsx",
    range = "B7:AZ8",col_names = TRUE,.name_repair = "unique_quiet"))))/12
pop2022 <- as.vector(t(as.matrix(USAPOP[2022 - 2007,2:dim(USAPOP)[2]])))
resp <- avg2022/pop2022
urb <- c()
perPop <- c()
```
